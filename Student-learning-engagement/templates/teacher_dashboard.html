{% extends "base.html" %}

{% macro get_student_performance(student) %}
    {% set recent_session = student.sessions|selectattr('quiz_score', 'defined')|selectattr('quiz_score', 'ne', none)|list %}
    {% if recent_session and recent_session[0].quiz_score is not none %}
        {% set score = recent_session[0].quiz_score %}
        {% set badge_class = 'success' if score >= 70 else 'warning' if score >= 50 else 'danger' %}
        {% set status_text = 'Excellent' if score >= 90 else 'Good' if score >= 70 else 'Needs Improvement' if score >= 50 else 'At Risk' %}
        {{ {'score': score, 'badge_class': badge_class, 'status_text': status_text, 'has_data': true} }}
    {% else %}
        {{ {'score': null, 'badge_class': 'secondary', 'status_text': 'No Data', 'has_data': false} }}
    {% endif %}
{% endmacro %}

{% block content %}
<div class="container">
    <!-- Statistics Cards -->
     <!--
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Students</h5>
                    <h2 class="card-text">{{ total_students }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Resources</h5>
                    <h2 class="card-text">{{ total_resources }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Average Quiz Score</h5>
                    <h2 class="card-text">{{ "%.1f"|format(avg_score) }}%</h2>
                </div>
            </div>
        </div>
    </div>-->

    <!-- Combined Analytics & Student Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Analytics & Student Progress
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Enhanced Statistics Row -->
             <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white stat-card">
                                <div class="card-body text-center">
                                    <div class="circular-stat">
                                        <div class="stat-circle">
                                            <h3 class="stat-value">{{ total_students }}</h3>
                                        </div>
                                        <p class="stat-label">ACTIVE STUDENTS</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white stat-card">
                                <div class="card-body text-center">
                                    <div class="circular-stat">
                                        <div class="stat-circle">
                                            <h3 class="stat-value">{{ total_resources }}</h3>
                                        </div>
                                        <p class="stat-label">RESOURCES</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white stat-card">
                                <div class="card-body text-center">
                                    <div class="circular-stat">
                                        <div class="stat-circle">
                                            <h3 class="stat-value">{{ "%.1f"|format(avg_score) }}%</h3>
                                        </div>
                                        <p class="stat-label">AVG. QUIZ SCORE</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white stat-card">
                                <div class="card-body text-center">
                                    <div class="circular-stat">
                                        <div class="stat-circle">
                                            <h3 class="stat-value">{{ "%.1f"|format(avg_engagement_time) if avg_engagement_time else 0 }}m</h3>
                                        </div>
                                        <p class="stat-label">AVG. ENGAGEMENT</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> 

                    <!-- Quick Actions -->
                  <!--
                      <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-2">
                                <a href="{{ url_for('student_analytics') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-chart-bar me-1"></i>Detailed Analytics
                                </a>
                                <a href="{{ url_for('teacher_student_progress') }}" class="btn btn-outline-success">
                                    <i class="fas fa-chart-line me-1"></i>Student Progress Reports
                                </a>
                                <a href="{{ url_for('real_time_tracking') }}" class="btn btn-outline-info">
                                    <i class="fas fa-eye me-1"></i>Live Tracking
                                </a>
                                <a href="{{ url_for('teacher_insights') }}" class="btn btn-outline-warning">
                                    <i class="fas fa-brain me-1"></i>AI Insights
                                </a>
                            </div>
                        </div>
                    </div>-->

                    <!-- Student Performance Overview -->
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-users me-2"></i>Student Performance Overview</h5>
                            {% if students %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Student</th>
                                            <th>Grade</th>
                                            <th>Recent Score</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in students[:10] %}
                                        {% set performance = get_student_performance(student) %}
                                        <tr>
                                            <td>
                                                <strong>{{ student.name }}</strong><br>
                                                <small class="text-muted">{{ student.student_id }}</small>
                                            </td>
                                            <td>{{ student.grade }}</td>
                                            <td>
                                                {% if performance.has_data %}
                                                    <span class="badge bg-{{ performance.badge_class }}">
                                                        {{ performance.score }}%
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">No scores</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ performance.badge_class }}">
                                                    {{ performance.status_text }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{{ url_for('student_detailed_report', student_id=student.id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>View Details
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if students|length > 10 %}
                            <div class="text-center mt-3">
                                <a href="{{ url_for('teacher_student_progress') }}" class="btn btn-outline-primary">View All Students</a>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>No students found. <a href="{{ url_for('add_student') }}">Add your first student</a>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h5><i class="fas fa-chart-pie me-2"></i>Performance Distribution</h5>
                            <div class="card">
                                <div class="card-body">
                                    <canvas id="performanceChart" width="300" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Teacher Dashboard</h2>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('real_time_tracking') }}" class="btn btn-outline-success">
                        <i class="fas fa-chart-line me-1"></i>Live Tracking
                    </a>
                    <a href="{{ url_for('teacher_insights') }}" class="btn btn-outline-primary">Insights</a>
                    <button id="train-ml" class="btn btn-outline-secondary">Train model</button>
                    <a href="{{ url_for('add_student') }}" class="btn btn-primary"></a>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('train-ml');
        if (btn) {
            btn.addEventListener('click', async function() {
                btn.disabled = true;
                btn.textContent = 'Training...';
                try {
                    const resp = await fetch('{{ url_for('ml_train') }}', { method: 'POST' });
                    const data = await resp.json();
                    alert('Training complete: ' + JSON.stringify(data));
                } catch (e) {
                    alert('Training failed: ' + e);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Train AI';
                }
            });
        }
    });
    </script>

    <!-- Quick Bulk Assignment -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Quick Bulk Assignment</h4>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Quickly assign a resource to all students in a specific grade:</p>
            <form method="POST" action="{{ url_for('assign_resource') }}" class="row g-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="assignment_type" value="grade">
                <div class="col-md-4">
                    <label for="quick_resource_id" class="form-label">Select Resource</label>
                    <select class="form-select" id="quick_resource_id" name="resource_id" required>
                        <option value="">Choose a resource...</option>
                        {% for resource in resources[:5] %}
                        <option value="{{ resource.id }}">{{ resource.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="quick_grade" class="form-label">Select Grade</label>
                    <select class="form-select" id="quick_grade" name="grade" required>
                        <option value="">Choose grade...</option>
                        {% for student in students %}
                            {% if loop.first or student.grade != students[loop.index0-1].grade %}
                                <option value="{{ student.grade }}">Grade {{ student.grade }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="quick_max_students" class="form-label">Max Students for Key</label>
                    <input type="number" class="form-control" id="quick_max_students" name="max_students" value="10" min="1" max="100">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-users me-1"></i>Assign to Grade
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Students List -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Student Management</h4>
        </div>
        <div class="card-body">
            {% if students %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Student ID</th>
                            <th>Grade</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ student.name }}</td>
                            <td>{{ student.student_id }}</td>
                            <td>{{ student.grade }}</td>
                            <td>
                                <a href="{{ url_for('edit_student', id=student.id) }}" class="btn btn-warning btn-sm">Edit</a>
                                <form method="POST" action="{{ url_for('delete_student', id=student.id) }}" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this student?')">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                No students found. <a href="{{ url_for('add_student') }}">Add your first student</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Resources -->
    <div class="card">
        <div class="card-header">
            <h4>Recent Resources</h4>
        </div>
        <div class="card-body">
            {% if resources %}
            <div class="row">
                {% for resource in resources[:6] %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">{{ resource.title }}</h6>
                            <p class="card-text text-muted">{{ resource.description[:100] }}...</p>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-secondary">{{ resource.resource_type.title() }}</span>
                                <small class="text-muted">{{ resource.created_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('view_student_notes', resource_id=resource.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-sticky-note me-1"></i>View Notes
                                </a>
                                <a href="{{ url_for('quiz_results', quiz_id=resource.id) }}" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-chart-bar me-1"></i>Quiz Results
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="text-center mt-3">
                <a href="{{ url_for('teacher_resources') }}" class="btn btn-outline-primary">View All Resources</a>
            </div>
            {% else %}
            <div class="alert alert-info">
                No resources uploaded yet. <a href="{{ url_for('teacher_resources') }}">Upload your first resource</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.stat-card {
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.circular-stat {
    padding: 10px;
}

.stat-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
}

.stat-label {
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 1px;
    margin: 0;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Performance Distribution Chart
    const ctx = document.getElementById('performanceChart');
    if (ctx) {
        // Calculate performance distribution
        const students = [
            {% for student in students %}
            {
                id: {{ student.id }},
                name: "{{ student.name|e }}",
                grade: "{{ student.grade }}",
                sessions: [
                    {% for session in student.sessions %}
                    {
                        id: {{ session.id }},
                        quiz_score: {{ session.quiz_score if session.quiz_score is not none else 'null' }},
                        start_time: "{{ session.start_time }}"
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Helper function to get student performance (matches template logic)
        function getStudentPerformance(student) {
            const sessions = student.sessions || [];
            const recentSession = sessions.find(s => s.quiz_score !== null && s.quiz_score !== undefined);
            
            if (recentSession && recentSession.quiz_score !== null && recentSession.quiz_score !== undefined) {
                const score = recentSession.quiz_score;
                return {
                    score: score,
                    badgeClass: score >= 70 ? 'success' : score >= 50 ? 'warning' : 'danger',
                    statusText: score >= 90 ? 'Excellent' : score >= 70 ? 'Good' : score >= 50 ? 'Needs Improvement' : 'At Risk',
                    hasData: true
                };
            } else {
                return {
                    score: null,
                    badgeClass: 'secondary',
                    statusText: 'No Data',
                    hasData: false
                };
            }
        }
        
        let excellent = 0, good = 0, needsImprovement = 0, atRisk = 0, noData = 0;
        
        students.forEach(student => {
            const performance = getStudentPerformance(student);
            
            if (performance.hasData) {
                const score = performance.score;
                if (score >= 90) excellent++;
                else if (score >= 70) good++;
                else if (score >= 50) needsImprovement++;
                else atRisk++;
            } else {
                noData++;
            }
        });
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Excellent (90%+)', 'Good (70-89%)', 'Needs Improvement (50-69%)', 'At Risk (<50%)', 'No Data'],
                datasets: [{
                    data: [excellent, good, needsImprovement, atRisk, noData],
                    backgroundColor: [
                        '#28a745',
                        '#17a2b8',
                        '#ffc107',
                        '#dc3545',
                        '#6c757d'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %} 